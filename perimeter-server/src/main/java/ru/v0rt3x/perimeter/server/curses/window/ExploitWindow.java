package ru.v0rt3x.perimeter.server.curses.window;

import ru.v0rt3x.perimeter.server.curses.CursesConsoleUtils;
import ru.v0rt3x.perimeter.server.curses.utils.KeyCode;
import ru.v0rt3x.perimeter.server.curses.utils.MouseKey;
import ru.v0rt3x.perimeter.server.curses.utils.Window;
import ru.v0rt3x.perimeter.server.exploit.dao.Exploit;
import ru.v0rt3x.perimeter.server.exploit.dao.ExploitExecutionResultRepository;
import ru.v0rt3x.perimeter.server.exploit.dao.ExploitRepository;
import ru.v0rt3x.perimeter.server.shell.console.ConsoleColor;
import ru.v0rt3x.perimeter.server.shell.console.ConsoleTextStyle;

import java.io.IOException;

import static ru.v0rt3x.perimeter.server.shell.console.ConsoleColor.*;
import static ru.v0rt3x.perimeter.server.shell.console.ConsoleColor.BRIGHT_RED;
import static ru.v0rt3x.perimeter.server.shell.console.ConsoleTextStyle.*;
import static ru.v0rt3x.perimeter.server.shell.console.ConsoleTextStyle.NORMAL;

public class ExploitWindow extends Window {

    private final ExploitRepository exploitRepository;
    private final ExploitExecutionResultRepository resultRepository;

    public ExploitWindow(CursesConsoleUtils curses, ExploitRepository exploitRepository, ExploitExecutionResultRepository resultRepository) {
        super(curses, "Exploit Statistics", 22, 49, Math.max(7, curses.getScreenHeight() - 24), 58, RED, BRIGHT_WHITE, null);

        this.exploitRepository = exploitRepository;
        this.resultRepository = resultRepository;
    }

    @Override
    protected void onMouseClick(MouseKey key, int x, int y) throws IOException {

    }

    @Override
    protected void onDraw() throws IOException {
        write(2, 2, BRIGHT_WHITE, BOLD, String.format("Exploits Registered: %s", exploitRepository.count()));

        write(4, 2, BRIGHT_WHITE, BOLD, "Name");
        write(4, 15, BRIGHT_WHITE, BOLD, "Type");
        write(4, 24, BRIGHT_WHITE, BOLD, "Priority");
        write(4, 33, BRIGHT_WHITE, BOLD, "Hits");
        write(4, 41, BRIGHT_WHITE, BOLD, "Last Run");

        int line = 5;
        for (Exploit exploit: exploitRepository.findAll()) {
            long countTotal = resultRepository.findAllByExploit(exploit).stream()
                .filter(result -> result.getExitCode() != 68)
                .count();

            long countSuccess = resultRepository.findAllByExploit(exploit).stream()
                .filter(result -> result.getExitCode() == 0)
                .count();

            ConsoleColor statusColor = exploit.isDisabled() ? BRIGHT_WHITE : ((countSuccess == countTotal) ? BRIGHT_GREEN : BRIGHT_RED);
            ConsoleTextStyle statusStyle = exploit.isDisabled() ? STRIKED : NORMAL;
            String lastRunStatus = exploit.isDisabled() ? "DISABLED" : String.format("%02d / %02d", countSuccess, countTotal);

            write(line, 2, BRIGHT_WHITE, statusStyle, curses.wrapLine(exploit.getName(), 12));
            write(line, 15, BRIGHT_WHITE, statusStyle, curses.wrapLine(exploit.getType(), 8));
            write(line, 24, BRIGHT_WHITE, statusStyle, curses.wrapLine(exploit.getPriority().toString(), 8));
            write(line, 33, BRIGHT_WHITE, statusStyle, String.format("%07d", exploit.getHits()));
            write(line, 41, statusColor, statusStyle, lastRunStatus);

            line++;
        }
    }

    @Override
    public void onKeyPress(KeyCode keyCode) throws IOException {

    }
}
